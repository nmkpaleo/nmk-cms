name: release-on-prod-merge

on:
  pull_request:
    types:
      - closed
    branches:
      - prod

permissions:
  contents: write
  pull-requests: read

jobs:
  tag-and-release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine release bump
        id: bump
        env:
          LABELS_JSON: ${{ toJson(github.event.pull_request.labels.*.name) }}
        run: |
          if echo "$LABELS_JSON" | grep -q '"release:major"'; then
            echo "kind=major" >> "$GITHUB_OUTPUT"
          elif echo "$LABELS_JSON" | grep -q '"release:minor"'; then
            echo "kind=minor" >> "$GITHUB_OUTPUT"
          else
            echo "kind=patch" >> "$GITHUB_OUTPUT"
          fi

      - name: Compute next version
        id: version
        env:
          BUMP_KIND: ${{ steps.bump.outputs.kind }}
        run: |
          latest_tag=$(git tag -l 'v*' --sort=-v:refname | head -n 1)
          if [ -z "$latest_tag" ]; then
            latest_tag="v0.0.0"
          fi

          version="${latest_tag#v}"
          IFS='.' read -r major minor patch <<< "$version"

          case "$BUMP_KIND" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            *)
              patch=$((patch + 1))
              ;;
          esac

          next_tag="v${major}.${minor}.${patch}"
          echo "latest=$latest_tag" >> "$GITHUB_OUTPUT"
          echo "tag=$next_tag" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        env:
          NEXT_TAG: ${{ steps.version.outputs.tag }}
        run: |
          if git rev-parse "$NEXT_TAG" >/dev/null 2>&1; then
            echo "Tag $NEXT_TAG already exists; skipping."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$NEXT_TAG" -m "Release $NEXT_TAG"
          git push origin "$NEXT_TAG"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          target_commitish: ${{ github.event.pull_request.merge_commit_sha }}
          generate_release_notes: true
          name: ${{ steps.version.outputs.tag }}
          body: |
            Automated release from PR #${{ github.event.pull_request.number }}.
            Previous tag: ${{ steps.version.outputs.latest }}
            Bump type: ${{ steps.bump.outputs.kind }}
