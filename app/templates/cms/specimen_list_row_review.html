{% extends "base_generic.html" %}
{% load i18n %}

{% block content %}
<main class="w3-container w3-content" style="max-width: 1200px;">
  <header class="w3-padding-16">
    <h1 class="w3-xxlarge">
      <i class="fa fa-table" aria-hidden="true"></i>
      {% trans "Specimen list row review" %}
    </h1>
    <p class="w3-text-grey">
      {% trans "Review extracted rows, edit JSON payloads, and approve or reject candidates." %}
    </p>
  </header>

  <section class="w3-card w3-white w3-padding w3-margin-bottom" aria-label="{% trans 'Row review filters' %}">
    <form method="get" class="w3-container">
      <div class="w3-row-padding">
        {% for field in filter.form %}
          <div class="w3-third w3-section">
            <label class="w3-text-grey" for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
          </div>
        {% endfor %}
      </div>
      <div class="w3-section">
        <button class="w3-button w3-blue w3-round-large" type="submit">
          <i class="fa fa-filter" aria-hidden="true"></i>
          {% trans "Apply filters" %}
        </button>
      </div>
    </form>
  </section>

  <section class="w3-card w3-white w3-padding" aria-label="{% trans 'Row candidates' %}">
    <div class="w3-responsive">
      <table class="w3-table w3-striped">
        <thead>
          <tr>
            <th>{% trans "Source" %}</th>
            <th>{% trans "Page" %}</th>
            <th>{% trans "Row" %}</th>
            <th>{% trans "Status" %}</th>
            <th>{% trans "Confidence" %}</th>
            <th>{% trans "Data" %}</th>
            <th>{% trans "Actions" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for row in page_obj %}
            <tr>
              <td>{{ row.page.pdf.source_label }}</td>
              <td>{{ row.page.page_number }}</td>
              <td>{{ row.row_index }}</td>
              <td>{{ row.get_status_display }}</td>
              <td>
                {% if row.confidence %}
                  {{ row.confidence|floatformat:2 }}
                {% else %}
                  â€”
                {% endif %}
              </td>
              <td>
                <article class="w3-small">
                  <pre class="w3-small">{{ row.data|pprint }}</pre>
                </article>
              </td>
              <td>
                <form method="post" class="w3-container w3-padding-small">
                  {% csrf_token %}
                  <input type="hidden" name="row_id" value="{{ row.id }}">
                  <div class="w3-section">
                    <label class="w3-text-grey" for="status-{{ row.id }}">{% trans "Status" %}</label>
                    <select id="status-{{ row.id }}" name="status" class="w3-select">
                      {% for value,label in row_status_choices %}
                        <option value="{{ value }}" {% if row.status == value %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="w3-section">
                    <label class="w3-text-grey" for="data-{{ row.id }}">{% trans "Row data JSON" %}</label>
                    {% with script_id="row-data-"|add:row.id %}
                      {{ row.data|json_script:script_id }}
                      <textarea id="data-{{ row.id }}" name="data" class="w3-input" rows="4" data-source="{{ script_id }}"></textarea>
                    {% endwith %}
                  </div>
                  <div class="w3-section">
                    <button class="w3-button w3-green w3-round-large" type="submit" name="action" value="approve">
                      <i class="fa fa-check" aria-hidden="true"></i>
                      {% trans "Approve" %}
                    </button>
                    <button class="w3-button w3-red w3-round-large" type="submit" name="action" value="reject">
                      <i class="fa fa-ban" aria-hidden="true"></i>
                      {% trans "Reject" %}
                    </button>
                    <button class="w3-button w3-blue w3-round-large" type="submit" name="action" value="edit">
                      <i class="fa fa-save" aria-hidden="true"></i>
                      {% trans "Save" %}
                    </button>
                  </div>
                </form>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="w3-center w3-text-grey">
                {% trans "No row candidates match the current filters." %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</main>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
    document.querySelectorAll("textarea[data-source]").forEach((textarea) => {
      const scriptId = textarea.getAttribute("data-source");
      const script = document.getElementById(scriptId);
      if (script && !textarea.value) {
        textarea.value = script.textContent.trim();
      }
    });
  </script>
{% endblock %}
