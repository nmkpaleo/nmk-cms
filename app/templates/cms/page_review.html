{% load static user_tags %}
{% load i18n %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />

    <title>{% trans "Specimen List Page Review" %}</title>
  </head>
  <body>
    <header class="site-header">
      <nav class="site-navigation w3-bar w3-white w3-card" role="navigation" aria-label="{% trans 'Primary navigation' %}">
        <a class="nav-logo w3-bar-item w3-button w3-hover-none w3-padding-16" href="{% url 'index' %}">
          <span class="sr-only">{% trans "National Museums of Kenya home" %}</span>
          <img src="{% static 'images/logo.jpg' %}" class="logo_image" alt="{% trans 'National Museums of Kenya logo' %}">
        </a>
        <div class="nav-items w3-hide-small">
          {% include "includes/navigation_links.html" with layout="desktop" %}
        </div>
        <button id="nav-toggle" class="w3-bar-item w3-button w3-hide-large w3-hide-medium" type="button" aria-expanded="false" aria-controls="primary-navigation">
          <span class="fa fa-bars" aria-hidden="true"></span>
          <span class="sr-only">{% trans "Toggle navigation" %}</span>
        </button>
        <div id="primary-navigation" class="w3-bar-block w3-white w3-hide w3-hide-large w3-hide-medium" data-collapsed="true">
          {% include "includes/navigation_links.html" with layout="mobile" %}
        </div>
      </nav>
    </header>

    <main class="w3-container w3-padding-0" role="main">
      <header class="w3-container">
        {% if read_only %}
          <div class="w3-margin-top">
            <a class="w3-button w3-light-grey w3-round" href="{% url 'specimen_list_queue' %}">
              <i class="fa fa-arrow-left" aria-hidden="true"></i>
              {% trans "Back to queue" %}
            </a>
          </div>
        {% endif %}
        <h1 class="w3-xxlarge">
          <i class="fa fa-file-text-o" aria-hidden="true"></i>
          {% trans "Specimen List Page Review" %}
        </h1>
      </header>

      <section class="w3-row-padding" aria-label="{% trans "Review workspace" %}" style="max-width: none;">
        <div class="w3-card w3-padding review-split" id="review-split">
          <article class="review-pane" id="review-pane-left">
            <div class="review-pane-inner">
        <header class="w3-container">
          <h2 class="w3-large">
            <i class="fa fa-image" aria-hidden="true"></i>
            {% trans "Page image" %}
          </h2>
        </header>
        <div class="w3-section">
          {% if page.image_file %}
            <div class="w3-margin-bottom">
              <label class="w3-small" for="zoom-range">{% trans "Zoom" %}</label>
              <input
                class="w3-input"
                id="zoom-range"
                type="range"
                min="50"
                max="200"
                value="100"
                aria-label="{% trans "Zoom level" %}"
              />
            </div>
            <div class="w3-margin-bottom">
              <label class="w3-small">
                <input
                  class="w3-check"
                  type="checkbox"
                  id="toggle-ocr"
                  aria-describedby="ocr-help"
                />
                {% trans "Show OCR overlay" %}
              </label>
              <p class="w3-small w3-text-grey" id="ocr-help">
                {% trans "Overlay appears when OCR data is available." %}
              </p>
            </div>
            <div class="w3-border w3-padding" style="position: relative; overflow: auto;">
              <img
                id="page-image"
                src="{{ page.image_file.url }}"
                alt="{% trans "Specimen list page image" %}"
                style="max-width: 100%; transform-origin: top left;"
              />
              <div id="ocr-overlay" class="w3-border" style="display: none; position: absolute; inset: 0; pointer-events: none;"></div>
            </div>
          {% else %}
            <p class="w3-text-grey">{% trans "No page image available." %}</p>
          {% endif %}
        </div>
      </div>
    </article>

            </div>
          </article>
          <div class="review-divider" id="review-divider" role="separator" aria-orientation="vertical" aria-label="{% trans "Resize panes" %}"></div>
          <aside class="review-pane" id="review-pane-right">
            <div class="review-pane-inner">
        <header class="w3-container">
          <h2 class="w3-large">
            <i class="fa fa-table" aria-hidden="true"></i>
            {% trans "Extracted rows" %}
          </h2>
        </header>

        <div class="w3-section">
          {% if read_only %}
            <div class="w3-panel w3-pale-blue w3-border">
              <p class="w3-margin-0">{% trans "Viewing mode: edits and actions are disabled." %}</p>
            </div>
          {% endif %}
          <div class="w3-bar w3-margin-bottom">
            {% if low_confidence_only %}
              <a class="w3-button w3-light-grey" href="?">{% trans "Show all rows" %}</a>
            {% else %}
              <a class="w3-button w3-light-grey" href="?low_confidence=1">{% trans "Show low-confidence only" %}</a>
            {% endif %}
            <span class="w3-small w3-text-grey w3-margin-left">
              {% blocktrans %}Threshold: {{ confidence_threshold }}{% endblocktrans %}
            </span>
          </div>

          <form method="post" class="w3-container" novalidate {% if read_only %}data-read-only="true"{% endif %}>
            {% csrf_token %}
            {{ formset.management_form }}
            {% if formset.non_form_errors %}
              <div class="w3-panel w3-red">
                {{ formset.non_form_errors }}
              </div>
            {% endif %}

            <div class="w3-responsive">
              <table class="w3-table w3-bordered w3-small review-table">
                <thead>
                  <tr class="w3-light-grey">
                    {% for column, label in column_label_pairs %}
                      <th data-column="{{ column }}">
                        <div class="review-header">
                          <span>{{ label }}</span>
                          {% if column not in "data_json,row_index,confidence" %}
                            <span class="review-shift-controls" aria-label="{% trans 'Shift column values' %}">
                              <button class="w3-button w3-tiny w3-light-grey shift-control" type="button" data-shift="up" data-column="{{ column }}" title="{% trans 'Shift up from selected row' %}">
                                <i class="fa fa-arrow-up" aria-hidden="true"></i>
                              </button>
                              <button class="w3-button w3-tiny w3-light-grey shift-control" type="button" data-shift="down" data-column="{{ column }}" title="{% trans 'Shift down from selected row' %}">
                                <i class="fa fa-arrow-down" aria-hidden="true"></i>
                              </button>
                            </span>
                          {% endif %}
                        </div>
                      </th>
                    {% endfor %}
                    <th>{% trans "Delete" %}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for form in formset.forms %}
                    <tr class="{% if form.row_id.value and form.row_id.value|stringformat:'s' in low_confidence_ids %}w3-pale-yellow{% endif %}">
                      {{ form.row_id }}
                      {% for name, field in form.ordered_fields %}
                        <td data-column="{{ name }}">
                          {{ field.errors }}
                          <div class="review-cell">
                            {{ field }}
                            {% if name not in "data_json,row_index,confidence" %}
                              <div class="review-cell-shift">
                                <button class="w3-button w3-tiny w3-light-grey shift-control" type="button" data-shift="up" title="{% trans 'Shift up from this row' %}">
                                  <i class="fa fa-arrow-up" aria-hidden="true"></i>
                                </button>
                                <button class="w3-button w3-tiny w3-light-grey shift-control" type="button" data-shift="down" title="{% trans 'Shift down from this row' %}">
                                  <i class="fa fa-arrow-down" aria-hidden="true"></i>
                                </button>
                              </div>
                            {% endif %}
                          </div>
                        </td>
                      {% endfor %}
                      <td>{{ form.DELETE }}</td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="{{ column_table_colspan }}" class="w3-text-grey">{% trans "No rows available." %}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            {% if not read_only %}
              <div class="w3-bar w3-margin-top">
                <button class="w3-button w3-blue" type="submit" name="action" value="save">
                  <i class="fa fa-save" aria-hidden="true"></i>
                  {% trans "Save draft" %}
                </button>
                <button class="w3-button w3-light-grey" type="submit" name="action" value="release">
                  {% trans "Release" %}
                </button>
                <button class="w3-button w3-green" type="submit" name="action" value="approve">
                  {% trans "Approve page" %}
                </button>
                <button class="w3-button w3-red" type="submit" name="action" value="reject">
                  {% trans "Reject page" %}
                </button>
                <button class="w3-button w3-orange" type="submit" name="action" value="not_specimen_list">
                  {% trans "Not a specimen list" %}
                </button>
              </div>
            {% endif %}
          </form>
        </div>
            </div>
          </aside>
        </div>
  </section>
</main>

<footer class="w3-container w3-small w3-text-grey">
  <p>{% trans "Review changes are saved to the audit history." %}</p>
</footer>

<script src="{% static 'javascript.js' %}"></script>
<script>
  (function () {
    var zoomRange = document.getElementById("zoom-range");
    var image = document.getElementById("page-image");
    var toggle = document.getElementById("toggle-ocr");
    var overlay = document.getElementById("ocr-overlay");

    if (zoomRange && image) {
      zoomRange.addEventListener("input", function () {
        image.style.transform = "scale(" + (zoomRange.value / 100) + ")";
      });
    }

    if (toggle && overlay) {
      toggle.addEventListener("change", function () {
        overlay.style.display = toggle.checked ? "block" : "none";
      });
    }

    var split = document.getElementById("review-split");
    var divider = document.getElementById("review-divider");
    var leftPane = document.getElementById("review-pane-left");
    var rightPane = document.getElementById("review-pane-right");
    var dragging = false;

    function setWidths(clientX) {
      if (!split || !leftPane || !rightPane) {
        return;
      }
      var rect = split.getBoundingClientRect();
      var minWidth = 240;
      var maxWidth = rect.width - minWidth;
      var offset = Math.min(Math.max(clientX - rect.left, minWidth), maxWidth);
      var leftPercent = (offset / rect.width) * 100;
      leftPane.style.flexBasis = leftPercent + "%";
      rightPane.style.flexBasis = (100 - leftPercent) + "%";
    }

    function startDrag(event) {
      dragging = true;
      document.body.classList.add("w3-unselectable");
      setWidths(event.clientX);
    }

    function stopDrag() {
      if (!dragging) {
        return;
      }
      dragging = false;
      document.body.classList.remove("w3-unselectable");
    }

    if (divider) {
      divider.addEventListener("mousedown", function (event) {
        event.preventDefault();
        startDrag(event);
      });
    }

    document.addEventListener("mousemove", function (event) {
      if (dragging) {
        setWidths(event.clientX);
      }
    });

    document.addEventListener("mouseup", stopDrag);

    var reviewTable = document.querySelector(".review-table");
    if (reviewTable) {
      var reviewForm = reviewTable.closest("form");
      if (reviewForm && reviewForm.dataset.readOnly === "true") {
        reviewTable.querySelectorAll("input, textarea, select, button.shift-control").forEach(function (node) {
          if (node.tagName === "BUTTON") {
            node.disabled = true;
            node.classList.add("w3-disabled");
          } else {
            node.disabled = true;
          }
        });
      }

      function getCellInput(cell) {
        return cell ? cell.querySelector("input, textarea, select") : null;
      }

      function readCellValue(input) {
        if (!input) {
          return null;
        }
        if (input.type === "checkbox") {
          return input.checked;
        }
        return input.value;
      }

      function writeCellValue(input, value) {
        if (!input) {
          return;
        }
        if (input.type === "checkbox") {
          input.checked = Boolean(value);
        } else {
          input.value = value ?? "";
        }
      }

      function shiftColumn(startRowIndex, cellIndex, direction) {
        var body = reviewTable.querySelector("tbody");
        if (!body) {
          return;
        }
        var rows = Array.prototype.slice.call(body.querySelectorAll("tr"));
        if (startRowIndex < 0 || startRowIndex >= rows.length) {
          return;
        }
        if (direction === "up") {
          for (var i = startRowIndex; i < rows.length - 1; i += 1) {
            var sourceInput = getCellInput(rows[i + 1].children[cellIndex]);
            var targetInput = getCellInput(rows[i].children[cellIndex]);
            writeCellValue(targetInput, readCellValue(sourceInput));
          }
          var lastInput = getCellInput(rows[rows.length - 1].children[cellIndex]);
          writeCellValue(lastInput, "");
        } else if (direction === "down") {
          for (var j = rows.length - 1; j > startRowIndex; j -= 1) {
            var fromInput = getCellInput(rows[j - 1].children[cellIndex]);
            var toInput = getCellInput(rows[j].children[cellIndex]);
            writeCellValue(toInput, readCellValue(fromInput));
          }
          var firstInput = getCellInput(rows[startRowIndex].children[cellIndex]);
          writeCellValue(firstInput, "");
        }
      }

      reviewTable.addEventListener("click", function (event) {
        if (reviewForm && reviewForm.dataset.readOnly === "true") {
          return;
        }
        var button = event.target.closest(".shift-control");
        if (!button) {
          return;
        }
        var cell = button.closest("td");
        if (!cell) {
          return;
        }
        var row = button.closest("tr");
        if (!row) {
          return;
        }
        var body = row.parentElement;
        var rowIndex = Array.prototype.indexOf.call(body.children, row);
        var cellIndex = Array.prototype.indexOf.call(row.children, cell);
        var direction = button.getAttribute("data-shift");
        if (!direction) {
          return;
        }
        shiftColumn(rowIndex, cellIndex, direction);
      });

      reviewTable.addEventListener("keydown", function (event) {
        if (reviewForm && reviewForm.dataset.readOnly === "true") {
          return;
        }
        if (!["ArrowUp", "ArrowDown"].includes(event.key)) {
          return;
        }
        var target = event.target;
        if (!target || !["INPUT", "TEXTAREA", "SELECT"].includes(target.tagName)) {
          return;
        }
        var cell = target.closest("td");
        var row = target.closest("tr");
        if (!cell || !row) {
          return;
        }
        var body = row.parentElement;
        if (!body) {
          return;
        }
        var rowIndex = Array.prototype.indexOf.call(body.children, row);
        var nextRowIndex = event.key === "ArrowUp" ? rowIndex - 1 : rowIndex + 1;
        if (nextRowIndex < 0 || nextRowIndex >= body.children.length) {
          return;
        }
        var cellIndex = Array.prototype.indexOf.call(row.children, cell);
        var nextRow = body.children[nextRowIndex];
        if (!nextRow || !nextRow.children[cellIndex]) {
          return;
        }
        var nextCell = nextRow.children[cellIndex];
        var nextInput = nextCell.querySelector("input, textarea, select");
        if (nextInput) {
          event.preventDefault();
          nextInput.focus();
          if (nextInput.select) {
            nextInput.select();
          }
        }
      });
    }
  })();
</script>
<style>
  .review-split {
    display: flex;
    gap: 0;
    max-height: 75vh;
    overflow: hidden;
  }
  .review-pane {
    flex: 1 1 50%;
    min-width: 240px;
    display: flex;
  }
  .review-pane-inner {
    flex: 1 1 auto;
    max-height: 75vh;
    overflow-y: auto;
  }
  .review-divider {
    width: 6px;
    cursor: col-resize;
    background: #e2e2e2;
  }
  .review-narrow {
    max-width: 140px;
  }
  .review-table td[data-column="data_json"] textarea {
    max-width: 160px;
  }
  .review-table td[data-column="row_index"] input,
  .review-table td[data-column="confidence"] input {
    max-width: 80px;
  }
  .review-header {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .review-shift-controls {
    display: flex;
    gap: 4px;
  }
  .review-cell {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .review-cell-shift {
    display: flex;
    gap: 4px;
  }
  .w3-unselectable {
    user-select: none;
  }
  @media (max-width: 992px) {
    .review-split {
      flex-direction: column;
      max-height: none;
    }
    .review-divider {
      width: 100%;
      height: 6px;
      cursor: row-resize;
    }
  }
</style>
  </body>
</html>
