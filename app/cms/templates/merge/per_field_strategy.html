{% extends "base_generic.html" %}
{% load i18n %}

{% block title %}{% trans "Merge field selection" %}{% endblock %}

{% block content %}
<main class="w3-container w3-margin-top" aria-labelledby="field-selection-heading">
  <header class="w3-margin-bottom">
    <h1 class="w3-xxlarge" id="field-selection-heading">{% trans "Merge field selection" %}</h1>
    <p class="w3-text-grey">{% trans "Review each field across all candidates and choose the value to keep in the merged record." %}</p>
  </header>

  <section class="w3-card w3-padding" aria-label="{% trans 'Field selection form' %}">
    <form method="post" action="{{ action_url|default:'' }}" class="w3-padding-16" novalidate>
      {% csrf_token %}
      {% if model_label %}
        <input type="hidden" name="model" value="{{ model_label }}" />
      {% endif %}
      {% if target_id %}
        <input type="hidden" name="target" value="{{ target_id }}" />
      {% endif %}
      {% if candidate_ids %}
        <input type="hidden" name="candidates" value="{{ candidate_ids }}" />
      {% endif %}

      <div class="w3-row-padding w3-margin-bottom">
        <div class="w3-col l6 m6 s12">
          <h2 class="w3-large w3-margin-top">{% trans "Candidates" %}</h2>
          <p class="w3-text-grey w3-small">
            {% blocktrans count candidate_count=form.candidates|length %}
              {{ candidate_count }} record selected for merging.
            {% plural %}
              {{ candidate_count }} records selected for merging.
            {% endblocktrans %}
          </p>
          <ul class="w3-ul w3-small">
            {% for candidate in form.candidates %}
              <li class="w3-padding-small">
                {% if candidate.role %}
                  {% if candidate.role == 'target' %}
                    <span class="w3-tag w3-round w3-blue w3-margin-right">{{ candidate.role|title }}</span>
                  {% else %}
                    <span class="w3-tag w3-round w3-green w3-margin-right">{{ candidate.role|title }}</span>
                  {% endif %}
                {% endif %}
                <strong>{{ candidate.label }}</strong>
                <span class="w3-text-grey">(#{{ candidate.key }})</span>
              </li>
            {% empty %}
              <li class="w3-padding-small w3-text-grey">{% trans "No candidates supplied." %}</li>
            {% endfor %}
          </ul>
        </div>
        <div class="w3-col l6 m6 s12">
          <div class="w3-panel w3-pale-blue w3-border w3-border-blue">
            <p class="w3-small" id="field-selection-help">{% trans "Select one value per field. The chosen values will be applied to the target record when the merge runs." %}</p>
          </div>
        </div>
      </div>

      <div class="w3-responsive">
        <table class="w3-table w3-bordered w3-striped" role="grid" aria-describedby="field-selection-help">
          <thead>
            <tr>
              <th scope="col" class="w3-text-grey">{% trans "Field" %}</th>
              {% for candidate in form.candidates %}
                <th scope="col" class="w3-center">{{ candidate.label }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for option in form.field_options %}
              {% with bound_field=option.bound_field %}
                {% with selected_value=bound_field.value %}
                <tr>
                  <th scope="row" class="w3-text-dark-grey">
                    {% with first_choice=option.choices|first %}
                      {% if first_choice %}
                        <label for="{{ option.field_name }}-{{ first_choice.key }}" class="w3-small">{{ option.label }}</label>
                      {% else %}
                        <span class="w3-small">{{ option.label }}</span>
                      {% endif %}
                    {% endwith %}
                    {% if bound_field.help_text %}
                      <p class="w3-text-grey w3-tiny">{{ bound_field.help_text }}</p>
                    {% endif %}
                    {% if bound_field.errors %}
                      <p class="w3-text-red w3-tiny">{{ bound_field.errors|join:", " }}</p>
                    {% endif %}
                  </th>
                  {% for choice in option.choices %}
                    {% with input_id=option.field_name|add:'-'|add:choice.key %}
                      <td class="w3-center">
                        <label class="w3-block" for="{{ input_id }}">
                          <input
                            class="w3-radio"
                            type="radio"
                            id="{{ input_id }}"
                            name="{{ option.field_name }}"
                            value="{{ choice.key }}"
                            {% if selected_value == choice.key %}checked{% endif %}
                          />
                          <span class="w3-small">
                            {{ choice.value }}
                            {% if choice.role %}
                              {% if choice.role == 'target' %}
                                <span class="w3-tag w3-round w3-margin-left w3-blue">{{ choice.role|title }}</span>
                              {% else %}
                                <span class="w3-tag w3-round w3-margin-left w3-light-grey">{{ choice.role|title }}</span>
                              {% endif %}
                            {% endif %}
                          </span>
                        </label>
                      </td>
                    {% endwith %}
                  {% endfor %}
                </tr>
                {% endwith %}
              {% endwith %}
            {% empty %}
              <tr>
                <td colspan="{{ form.candidates|length|add:1 }}" class="w3-center w3-text-grey">{% trans "No mergeable fields available." %}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <footer class="w3-margin-top">
        <button class="w3-button w3-blue w3-margin-right" type="submit">
          <span class="fa fa-check" aria-hidden="true"></span>
          <span class="w3-margin-left">{% trans "Apply selections" %}</span>
        </button>
        {% if cancel_url %}
          <a class="w3-button w3-light-grey" href="{{ cancel_url }}">
            <span class="fa fa-arrow-left" aria-hidden="true"></span>
            <span class="w3-margin-left">{% trans "Back" %}</span>
          </a>
        {% endif %}
      </footer>
    </form>
  </section>
</main>
{% endblock %}
