{% extends "base_generic.html" %}
{% load i18n %}

{% block title %}New Accession{% endblock %}

{% block head %}
  {{ wizard.form.media.css }}
{% endblock %}
{% block content %}
  <main class="w3-container" role="main">
    {% if wizard.steps.current == '0' %}
      <section class="w3-card w3-white w3-round-large w3-padding-large" aria-labelledby="accession-number-header">
        <header class="w3-margin-bottom">
          <h2 id="accession-number-header"><i class="fa fa-list-ol" aria-hidden="true"></i> {% trans "Select Accession Number" %}</h2>
        </header>
        <form action="" method="post">{% csrf_token %}
          {{ wizard.management_form }}
          <ul class="w3-ul">
            {% for val, label in wizard.form.fields.accession_number.choices %}
              <li>
                <a href="#" class="w3-text-blue" onclick="event.preventDefault(); document.getElementById('id_0-accession_number').value='{{ val }}'; this.closest('form').submit();">
                  {{ label }}
                </a>
              </li>
            {% endfor %}
          </ul>
          <input type="hidden" name="0-accession_number" id="id_0-accession_number" value="">
        </form>
      </section>
    {% else %}
      <section class="w3-card w3-white w3-round-large w3-padding-large" aria-labelledby="wizard-step-header">
        <header class="w3-margin-bottom">
          <h2 id="wizard-step-header"><i class="fa fa-clipboard-list" aria-hidden="true"></i> {% blocktrans %}Step {{ wizard.steps.step1 }} of {{ wizard.steps.count }}{% endblocktrans %}</h2>
        </header>
        <form action="" method="post" enctype="multipart/form-data">{% csrf_token %}
          {{ wizard.management_form }}
          {% for field in wizard.form %}
            {% if field.is_hidden %}
              {{ field }}
            {% elif wizard.steps.current == '1' and field.name == 'specimen_no' %}
              <article class="w3-margin-bottom" aria-label="{{ field.label }}">
                <label class="w3-text-blue"><b>{{ field.label }}</b></label>
                <p class="w3-padding w3-light-grey w3-round w3-border" aria-readonly="true">
                  {{ field.value|default_if_none:"" }}
                </p>
                <input type="hidden" name="{{ field.html_name }}" value="{{ field.value|default_if_none:'' }}">
                {% if field.errors %}
                  <div class="w3-text-red">{{ field.errors }}</div>
                {% endif %}
              </article>
            {% else %}
              <article class="w3-margin-bottom" aria-label="{{ field.label }}">
                <label class="w3-text-blue"><b>{{ field.label }}</b></label>
                {{ field }}
                {% if field.errors %}
                  <div class="w3-text-red">{{ field.errors }}</div>
                {% endif %}
              </article>
            {% endif %}
          {% endfor %}

          <div class="w3-margin-top">
            {% if wizard.steps.prev %}
              <button type="submit" class="w3-button w3-gray"
                      name="wizard_goto_step" value="{{ wizard.steps.prev }}">
                {% trans "Previous" %}
              </button>
            {% endif %}
            <button type="submit" class="w3-button w3-green">{% trans "Next" %}</button>
          </div>
        </form>
      </section>
    {% endif %}
  </main>
{% endblock %}
{% block extra_scripts %}
  {{ wizard.form.media.js }}

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Wait until the full page including DAL JS has loaded
      setTimeout(function () {
        console.log("üöß Found widgets:", document.querySelectorAll(".django-autocomplete-light"));
        if (window.dal && typeof window.dal.initialize === "function") {
          console.log("‚úÖ Initializing DAL manually on wizard step.");
          window.dal.initialize(document.body);
        } else {
          console.warn("‚ö†Ô∏è DAL not available.");
        }
      }, 100); // small delay to ensure everything is ready
    });
  </script>
{% endblock %}
