{% extends "base_generic.html" %}
{% load i18n %}

{% block title %}{% trans "Confirm element merge" %}{% endblock %}

{% block content %}
<main class="w3-container w3-margin-top" aria-labelledby="element-merge-confirm-heading">
  <header class="w3-row w3-padding-16 w3-white w3-round-large w3-border-bottom">
    <div class="w3-col s12 m8">
      <h1 id="element-merge-confirm-heading" class="w3-margin-0">
        <i class="fa-solid fa-object-group" aria-hidden="true"></i>
        <span class="w3-margin-left">{% trans "Review element merge" %}</span>
      </h1>
      <p class="w3-text-gray">
        {% blocktrans with specimen=accession_row.specimen_suffix accession=accession_row.accession %}Specimen {{ specimen }} · {{ accession }}{% endblocktrans %}
      </p>
    </div>
    <div class="w3-col s12 m4 w3-right-align w3-margin-top">
      <a href="{{ cancel_url }}" class="w3-button w3-light-grey w3-round">
        <i class="fa-solid fa-arrow-left" aria-hidden="true"></i>
        <span class="w3-margin-left">{% trans "Back to specimen" %}</span>
      </a>
    </div>
  </header>

  <section class="w3-margin-top w3-card w3-round w3-white w3-padding" aria-labelledby="element-merge-summary">
    <div class="w3-row">
      <div class="w3-col s12 m7">
        <h2 id="element-merge-summary" class="w3-margin-top">
          <i class="fa-solid fa-layer-group" aria-hidden="true"></i>
          <span class="w3-margin-left">{% trans "Selected elements" %}</span>
        </h2>
        <p class="w3-text-gray">
          {% trans "Confirm the target and sources before choosing field values to keep." %}
        </p>
      </div>
      <div class="w3-col s12 m5 w3-right-align w3-margin-top">
        <span class="w3-tag w3-blue w3-round w3-small">{% trans "Target" %}</span>
        <span class="w3-tag w3-amber w3-round w3-small w3-margin-left">{% trans "Source" %}</span>
      </div>
    </div>
    <ul class="w3-ul w3-border w3-round w3-margin-top">
      {% for candidate in selected_candidates %}
        <li class="w3-padding-small">
          {% if target_id == candidate.pk|stringformat:"s" %}
            <span class="w3-tag w3-blue w3-round w3-small w3-margin-right">{% trans "Target" %}</span>
          {% else %}
            <span class="w3-tag w3-amber w3-round w3-small w3-margin-right">{% trans "Source" %}</span>
          {% endif %}
          <span class="w3-text-bold">{{ candidate.element|default:_("Unknown element") }}</span>
          <span class="w3-text-gray w3-small w3-margin-left">
            {{ candidate.side|default:"" }}{% if candidate.verbatim_element %} · {{ candidate.verbatim_element }}{% endif %}
          </span>
        </li>
      {% endfor %}
    </ul>
  </section>

  <section class="w3-margin-top w3-card w3-round w3-white w3-padding" aria-labelledby="element-field-selection-heading">
    <h2 id="element-field-selection-heading" class="w3-margin-top">
      <i class="fa-solid fa-list-check" aria-hidden="true"></i>
      <span class="w3-margin-left">{% trans "Select preferred values" %}</span>
    </h2>
    {% if field_selection_form.non_field_errors %}
      <ul class="w3-text-red w3-small" role="alert">
        {% for error in field_selection_form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    <form
      method="post"
      action="{% url 'accession_merge_elements' accession_row.pk %}"
      class="w3-margin-top"
      aria-describedby="element-field-selection-heading"
    >
      {% csrf_token %}
      <input type="hidden" name="stage" value="confirm" />
      <input type="hidden" name="target" value="{{ target_id }}" />
      {% for selected_id in selected_ids %}
        <input type="hidden" name="selected_ids" value="{{ selected_id }}" />
      {% endfor %}

      {% for option in field_selection_form.field_options %}
        <fieldset class="w3-margin-top w3-padding w3-round w3-border">
          <legend class="w3-small w3-text-grey">{{ option.label }}</legend>
          {% if option.bound_field.errors %}
            <ul class="w3-text-red w3-small" role="alert">
              {% for error in option.bound_field.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
          <div class="w3-margin-top" role="radiogroup" aria-label="{{ option.label }}">
            {% for choice in option.choices %}
              <label class="w3-block w3-padding-small w3-hover-light-grey">
                <input
                  type="radio"
                  name="{{ option.field_name }}"
                  value="{{ choice.key }}"
                  {% if option.bound_field.value == choice.key %}checked="checked"{% endif %}
                />
                <span class="w3-margin-left">{{ choice.label }}</span>
                <span class="w3-margin-left w3-text-gray">{{ choice.value|default:"—" }}</span>
                {% if choice.is_target %}
                  <span class="w3-tag w3-blue w3-round w3-small w3-margin-left">{% trans "Target" %}</span>
                {% endif %}
              </label>
            {% endfor %}
          </div>
        </fieldset>
      {% endfor %}

      <div class="w3-margin-top">
        <a href="{{ cancel_url }}" class="w3-button w3-light-grey w3-round">
          <i class="fa-solid fa-circle-xmark" aria-hidden="true"></i>
          <span class="w3-margin-left">{% trans "Cancel" %}</span>
        </a>
        <button type="submit" class="w3-button w3-blue w3-round w3-margin-left">
          <i class="fa-solid fa-check" aria-hidden="true"></i>
          <span class="w3-margin-left">{% trans "Merge selected elements" %}</span>
        </button>
      </div>
    </form>
  </section>
</main>
{% endblock %}
