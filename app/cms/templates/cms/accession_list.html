{% extends "base_generic.html" %}
{% load user_tags %}

{% block title %}Accessions{% endblock %}

{% block content %}

<div class="w3-container w3-margin-top">
    <div class="w3-row w3-margin-bottom w3-padding-16 w3-border-bottom">
        <div class="w3-col s12 m6 l6">
            <h2 class="w3-margin-0">Accessions</h2>
        </div>
        <div class="w3-col s12 m6 l6 w3-right-align w3-margin-top">
            {% if user.is_authenticated %}
                {% if user.is_superuser or user|has_group:"Collection Managers" %}
                    <a href="{% url 'accession-wizard' %}" class="w3-button w3-green w3-round">
                        <i class="fa-solid fa-plus-circle"></i>
                        New Accession
                    </a>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <button type="button" onclick="toggleAccordion('accessionFilterPanel')" class="w3-button w3-light-grey w3-round-large">
        <i class="fa-solid fa-filter"></i>
        <span class="w3-margin-left">Show/Hide Filters</span>
    </button>

    <div id="accessionFilterPanel" class="w3-hide w3-animate-opacity w3-padding w3-light-grey w3-round-large w3-margin-top w3-card">
        <form method="get">
            <div class="w3-row-padding">
                <div class="w3-col s12 m6 l3 w3-margin-bottom">
                    <label class="w3-text-grey">Specimen Number</label>
                    {{ filter.form.specimen_no }}
                </div>
                <div class="w3-col s12 m6 l3 w3-margin-bottom">
                    <label class="w3-text-grey">Specimen Prefix</label>
                    {{ filter.form.specimen_prefix }}
                </div>
                <div class="w3-col s12 m6 l3 w3-margin-bottom">
                    <label class="w3-text-grey">Specimen Suffix</label>
                    {{ filter.form.specimen_suffix }}
                </div>
                <div class="w3-col s12 m6 l3 w3-margin-bottom">
                    <label class="w3-text-grey">Comment</label>
                    {{ filter.form.comment }}
                </div>
            </div>

            <div class="w3-row-padding">
                <div class="w3-col s12 m6 l3 w3-margin-bottom">
                    <label class="w3-text-grey">Taxon</label>
                    {{ filter.form.taxon }}
                </div>
                <div class="w3-col s12 m6 l3 w3-margin-bottom">
                    <label class="w3-text-grey">Element</label>
                    {{ filter.form.element }}
                </div>
                <div class="w3-col s12 m6 l3 w3-margin-bottom">
                    <label class="w3-text-grey">Family</label>
                    {{ filter.form.family }}
                </div>
                <div class="w3-col s12 m6 l3 w3-margin-bottom">
                    <label class="w3-text-grey">Subfamily</label>
                    {{ filter.form.subfamily }}
                </div>
            </div>

            <div class="w3-row-padding">
                <div class="w3-col s12 m6 l3 w3-margin-bottom">
                    <label class="w3-text-grey">Tribe</label>
                    {{ filter.form.tribe }}
                </div>
                <div class="w3-col s12 m6 l3 w3-margin-bottom">
                    <label class="w3-text-grey">Genus</label>
                    {{ filter.form.genus }}
                </div>
                <div class="w3-col s12 m6 l3 w3-margin-bottom">
                    <label class="w3-text-grey">Species</label>
                    {{ filter.form.species }}
                </div>
            </div>

            <div class="w3-margin-top">
                <button type="submit" class="w3-button w3-blue w3-round w3-margin-right">
                    <i class="fa-solid fa-check"></i>
                    Apply Filters
                </button>
                <a href="{% url 'accession_list' %}" class="w3-button w3-gray w3-round">
                    <i class="fa-solid fa-rotate-left"></i>
                    Clear
                </a>
            </div>
        </form>
    </div>

    <div class="w3-responsive w3-margin-top">
        <table class="w3-table-all w3-hoverable">
            <thead>
                <tr>
                    <th>Collection</th>
                    <th>Specimen Prefix</th>
                    <th>Specimen Number</th>
                    <th>Taxon</th>
                    <th>Element</th>
                    {% if user.is_superuser or user|has_group:"Collection Managers" %}
                        <th>Accessioned By</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for accession in accessions %}
                    <tr>
                        <td>
                            <a href="{% url 'accession_detail' accession.pk %}">{{ accession.collection.abbreviation }}</a>
                        </td>
                        <td>{{ accession.specimen_prefix.abbreviation }}</td>
                        <td>{{ accession.specimen_no }}</td>
                        <td>
                            {% if accession.taxa_list %}
                                {{ accession.taxa_list|join:", " }}
                            {% else %}
                                &mdash;
                            {% endif %}
                        </td>
                        <td>
                            {% if accession.element_list %}
                                {{ accession.element_list|join:", " }}
                            {% else %}
                                &mdash;
                            {% endif %}
                        </td>
                        {% if user.is_superuser or user|has_group:"Collection Managers" %}
                            <td>{{ accession.accessioned_by }}</td>
                        {% endif %}
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="{% if user.is_superuser or user|has_group:"Collection Managers" %}6{% else %}5{% endif %}" class="w3-center">No accessions found.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block script %}
    <script>
        function toggleAccordion(id) {
            const panel = document.getElementById(id);
            if (panel.classList.contains('w3-show')) {
                panel.classList.remove('w3-show');
                panel.classList.add('w3-hide');
            } else {
                panel.classList.remove('w3-hide');
                panel.classList.add('w3-show');
            }
        }
    </script>
{% endblock %}
