{% extends "base_generic.html" %}
{% load i18n custom_filters user_tags static %}

{% block title %}{% blocktrans with accession_number=accession %}Accession {{ accession_number }}{% endblocktrans %}{% endblock %}

{% block content %}
<main class="w3-container w3-margin-top" role="main">
  <header class="w3-row w3-padding-16 w3-border-bottom w3-white w3-round-large" aria-labelledby="accession-details-heading">
    <div class="w3-col s12 m8">
      <h1 id="accession-details-heading" class="w3-margin-0">
        {% blocktrans with accession_number=accession %}Accession {{ accession_number }}{% endblocktrans %}
      </h1>
      <p class="w3-text-gray">{{ accession.collection }}</p>
    </div>
    {% if user.is_superuser or user|has_group:"Collection Managers" %}
      <div class="w3-col s12 m4 w3-right-align w3-margin-top">
        <a href="{% url 'accession_edit' accession.pk %}" class="w3-button w3-blue w3-round" aria-label="{% trans 'Edit accession' %}">
          <i class="fa-solid fa-pen-to-square" aria-hidden="true"></i>
          <span class="w3-hide-small w3-margin-left">{% trans "Edit Accession" %}</span>
        </a>
      </div>
    {% endif %}
  </header>

  {% include "cms/partials/accession_preview_panel.html" with preview_mode=False can_edit_accession_rows=can_edit_accession_rows specimen_table_empty_colspan=specimen_table_empty_colspan %}

  <section class="w3-margin-top accession-lower-area" aria-labelledby="accession-comments-heading">
    <header class="w3-row w3-padding-16">
      <div class="w3-col s12 m6">
        <h2 id="accession-comments-heading" class="w3-margin-0">
          <i class="fa-solid fa-comments" aria-hidden="true"></i>
          <span class="w3-margin-left">{% trans "Comments" %}</span>
        </h2>
      </div>
      {% if user.is_authenticated and user|has_group:"Collection Managers" %}
        <div class="w3-col s12 m6 w3-right-align">
          <a href="{% url 'accession_add_comment' accession.id %}" class="w3-button w3-green w3-round">
            <i class="fa-solid fa-plus" aria-hidden="true"></i>
            <span class="w3-hide-small w3-margin-left">{% trans "Add comment" %}</span>
          </a>
        </div>
      {% endif %}
    </header>
    {% if comments %}
      <div class="w3-responsive">
        <table class="w3-table-all w3-hoverable w3-small">
          <thead>
            <tr>
              <th scope="col">{% trans "Subject" %}</th>
              <th scope="col">{% trans "Comment" %}</th>
              <th scope="col">{% trans "Comment by" %}</th>
              <th scope="col">{% trans "Status" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for comment in comments %}
              <tr>
                <td>{{ comment.subject|default:"—" }}</td>
                <td>{{ comment.comment|default:"—" }}</td>
                <td>{{ comment.comment_by|default:"—" }}</td>
                <td>{{ comment.get_status_display|default:"—" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="w3-text-gray">{% trans "No comments recorded for this accession." %}</p>
    {% endif %}
  </section>

  {% if user.is_superuser or user|has_group:"Collection Managers" %}
    <div
      id="fieldSlipModal"
      class="w3-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="fieldSlipModalTitle"
      aria-hidden="true"
      data-create-url="{% url 'accession_create_fieldslip' accession.pk %}"
    >
      <div class="w3-modal-content w3-card-4 w3-animate-top" style="max-width: 800px;">
        <header class="w3-container w3-blue">
          <button
            id="fieldSlipModalCloseButton"
            type="button"
            onclick="closeFieldSlipModal()"
            class="w3-button w3-display-topright"
            aria-label="{% trans 'Close modal' %}"
          >&times;</button>
          <h2 id="fieldSlipModalTitle">{% trans "Create and link new field slip" %}</h2>
        </header>
        <div class="w3-container">
          <iframe id="fieldSlipFrame" src="" width="100%" height="500" style="border: none;" title="{% trans 'Field slip form' %}"></iframe>
        </div>
        <footer class="w3-container w3-padding w3-light-grey">
          <button type="button" onclick="closeFieldSlipModal()" class="w3-button w3-red">{% trans "Cancel" %}</button>
        </footer>
      </div>
    </div>
  {% endif %}

  <div
    id="media-hover-preview"
    class="accession-media-hover-preview w3-card w3-round-large w3-white w3-padding"
    role="tooltip"
    aria-hidden="true"
  >
    <img id="media-hover-preview-img" src="" alt="" class="w3-image" />
  </div>
</main>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'cms/js/accession_media_preview.js' %}" defer></script>
<script>
  (function () {
    const modal = document.getElementById("fieldSlipModal");
    const modalFrame = document.getElementById("fieldSlipFrame");
    const closeButton = document.getElementById("fieldSlipModalCloseButton");
    const backgroundRegion = document.getElementById("accession-fieldslip-actions");
    let previouslyFocusedElement = null;

    const select2jQuery = window.jQuery || (window.django && window.django.jQuery);

    function closeSelect2Dropdowns() {
      if (select2jQuery) {
        select2jQuery(".django-select2").each(function () {
          const instance = select2jQuery(this);
          if (instance.data("select2")) {
            instance.select2("close");
          }
        });
      }

      document
        .querySelectorAll(".select2-container--open")
        .forEach((container) => container.classList.remove("select2-container--open"));
      document
        .querySelectorAll(".select2-dropdown")
        .forEach((dropdown) => {
          dropdown.setAttribute("aria-hidden", "true");
          dropdown.style.display = "none";
        });
    }

    function showModal() {
      if (!modal || !modalFrame) {
        return;
      }

      closeSelect2Dropdowns();

      previouslyFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;

      const createUrl = modal.dataset.createUrl;
      if (createUrl) {
        modalFrame.src = createUrl;
      }

      modal.style.display = "block";
      modal.setAttribute("aria-hidden", "false");

      if (backgroundRegion) {
        backgroundRegion.setAttribute("aria-hidden", "true");
        backgroundRegion.setAttribute("inert", "");
      }

      if (closeButton) {
        closeButton.focus();
      }
    }

    function hideModal() {
      if (!modal || !modalFrame) {
        return;
      }

      modal.style.display = "none";
      modal.setAttribute("aria-hidden", "true");
      modalFrame.src = "";

      if (backgroundRegion) {
        backgroundRegion.removeAttribute("aria-hidden");
        backgroundRegion.removeAttribute("inert");
      }

      if (previouslyFocusedElement && document.body.contains(previouslyFocusedElement)) {
        previouslyFocusedElement.focus();
      }

      previouslyFocusedElement = null;
    }

    if (modal) {
      modal.addEventListener("click", (event) => {
        if (event.target === modal) {
          hideModal();
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && modal.style.display === "block") {
          event.preventDefault();
          hideModal();
        }
      });
    }

    window.openFieldSlipModal = showModal;
    window.closeFieldSlipModal = hideModal;
    window.closeModalAndRefresh = function () {
      hideModal();
      window.location.reload();
    };
  })();
</script>
{% endblock %}
