{% extends "base_generic.html" %}
{% load custom_filters %}
{% load user_tags %}

{% block title %}Accession {{ accession }}{% endblock %}

{% block content %}
    <div class="template-detail-container">
        <div class="template-detail-header">
            <h2 class="accession-detail-h2">Accession Detail</h2>
            {% if user.is_superuser or user|has_group:"Collection Managers" %}
            <a href="{% url 'accession_edit' accession.pk %}" class="edit-icon">
                Edit Form ✏️
            </a>
            {% endif %}
        </div>
        {% include "cms/partials/accession_preview_panel.html" with preview_mode=False %}
        <div class="grid-containerr">
            <div class="cards">
                <hr class="accession_hr">
                {% if user.is_authenticated and user|has_group:"Collection Managers" %}
                  <a href="{% url 'accession_add_comment' accession.id %}">➕ Add Comment</a>
                {% endif %}
                {% if comments %}
                    <table>
                        <caption>Comments</caption>
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Comment</th>
                                <th>Comment by</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        {% for comment in comments %}
                            <tbody>
                                <tr>
                                    <td>{{ comment.subject }}</td>
                                    <td>{{ comment.comment }}</td>
                                    <td>{{ comment.comment_by }}</td>
                                    <td>{{ comment.get_status_display }}</td>
                                </tr>
                            </tbody>
                        {% endfor %}
                    </table>
                {% else %}
                    <p>No Comments found for this accession.</p>
                {% endif %}
            </div>
            {% if user.is_superuser or user|has_group:"Collection Managers" %}
            <div class="cards">
                <table class="table">
                    <caption><b><u>Related FieldSlips</u></b></caption>
                    <thead>
                        <tr>
                            <th>Field Number</th>
                            <th>Verbatim Taxon</th>
                            <th>Verbatim Element</th>
                            <th>Verbatim Locality</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for relation in related_fieldslips %}
                        <tr>
                            <td>
                                <a href="{% url 'fieldslip_detail' relation.fieldslip.pk %}">{{ relation.fieldslip.field_number }}</a>
                            </td>
                            <td>{{ relation.fieldslip.verbatim_taxon }}</td>
                            <td>{{ relation.fieldslip.verbatim_element }}</td>
                            <td>{{ relation.fieldslip.verbatim_locality }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4">No FieldSlips linked.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <h5><strong><u>Add Existing FieldSlip</u></strong></h5>
                {{ add_fieldslip_form.media }}
                <form method="POST" action="{% url 'accession_add_fieldslip' accession.pk %}">
                    {% csrf_token %}
                    {{ add_fieldslip_form }}
                    <button type="submit" class="btn btn-primary">Add FieldSlip</button>
                </form>
                <h5><strong><u>Create and Link New FieldSlip</u></strong></h5>

                <!-- Button to open the modal -->
                <button onclick="openFieldSlipModal()" class="accesssin_FieldSlip">➕ Add a New FieldSlip</button>

                <!-- Modal (hidden by default) -->
                <div id="fieldSlipModal" class="w3-modal">
                    <div class="w3-modal-content w3-card-4 w3-animate-top" style="max-width: 800px;">
                        <header class="w3-container w3-blue">
                            <span onclick="closeFieldSlipModal()" class="w3-button w3-display-topright">&times;</span>
                            <h2>Create and Link New FieldSlip</h2>
                        </header>
                        <div class="w3-container">
                            <iframe id="fieldSlipFrame" src="" width="100%" height="500px" style="border: none;"></iframe>
                        </div>
                        <footer class="w3-container w3-padding w3-light-grey">
                            <button onclick="closeFieldSlipModal()" class="w3-button w3-red">Cancel</button>
                        </footer>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
    function openFieldSlipModal() {
        var url = "{% url 'accession_create_fieldslip' accession.pk %}";
        document.getElementById("fieldSlipFrame").src = url;
        document.getElementById("fieldSlipModal").style.display = "block";
    }

    function closeFieldSlipModal() {
        document.getElementById("fieldSlipModal").style.display = "none";
        document.getElementById("fieldSlipFrame").src = ""; // Reset iframe content
    }

    function closeModalAndRefresh() {
        closeFieldSlipModal();
        location.reload(); // Refresh main page after successful save
    }
</script>
{% endblock %}