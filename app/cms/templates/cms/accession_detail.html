{% extends "base_generic.html" %}
{% load i18n custom_filters user_tags %}

{% block title %}{% blocktrans with accession_number=accession %}Accession {{ accession_number }}{% endblocktrans %}{% endblock %}

{% block content %}
<main class="w3-container w3-margin-top" role="main">
  <header class="w3-row w3-padding-16 w3-border-bottom w3-white w3-round-large" aria-labelledby="accession-details-heading">
    <div class="w3-col s12 m8">
      <h1 id="accession-details-heading" class="w3-margin-0">
        {% blocktrans with accession_number=accession %}Accession {{ accession_number }}{% endblocktrans %}
      </h1>
      <p class="w3-text-gray">{{ accession.collection }}</p>
    </div>
    {% if user.is_superuser or user|has_group:"Collection Managers" %}
      <div class="w3-col s12 m4 w3-right-align w3-margin-top">
        <a href="{% url 'accession_edit' accession.pk %}" class="w3-button w3-blue w3-round" aria-label="{% trans 'Edit accession' %}">
          <i class="fa-solid fa-pen-to-square" aria-hidden="true"></i>
          <span class="w3-hide-small w3-margin-left">{% trans "Edit Accession" %}</span>
        </a>
      </div>
    {% endif %}
  </header>

  {% include "cms/partials/accession_preview_panel.html" with preview_mode=False %}

  <section class="w3-margin-top accession-lower-area" aria-labelledby="accession-comments-heading">
    <header class="w3-row w3-padding-16">
      <div class="w3-col s12 m6">
        <h2 id="accession-comments-heading" class="w3-margin-0">
          <i class="fa-solid fa-comments" aria-hidden="true"></i>
          <span class="w3-margin-left">{% trans "Comments" %}</span>
        </h2>
      </div>
      {% if user.is_authenticated and user|has_group:"Collection Managers" %}
        <div class="w3-col s12 m6 w3-right-align">
          <a href="{% url 'accession_add_comment' accession.id %}" class="w3-button w3-green w3-round">
            <i class="fa-solid fa-plus" aria-hidden="true"></i>
            <span class="w3-hide-small w3-margin-left">{% trans "Add comment" %}</span>
          </a>
        </div>
      {% endif %}
    </header>
    {% if comments %}
      <div class="w3-responsive">
        <table class="w3-table-all w3-hoverable w3-small">
          <thead>
            <tr>
              <th scope="col">{% trans "Subject" %}</th>
              <th scope="col">{% trans "Comment" %}</th>
              <th scope="col">{% trans "Comment by" %}</th>
              <th scope="col">{% trans "Status" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for comment in comments %}
              <tr>
                <td>{{ comment.subject|default:"—" }}</td>
                <td>{{ comment.comment|default:"—" }}</td>
                <td>{{ comment.comment_by|default:"—" }}</td>
                <td>{{ comment.get_status_display|default:"—" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="w3-text-gray">{% trans "No comments recorded for this accession." %}</p>
    {% endif %}
  </section>

  {% if user.is_superuser or user|has_group:"Collection Managers" %}
    <div id="fieldSlipModal" class="w3-modal" role="dialog" aria-modal="true" aria-labelledby="fieldSlipModalTitle">
      <div class="w3-modal-content w3-card-4 w3-animate-top" style="max-width: 800px;">
        <header class="w3-container w3-blue">
          <button type="button" onclick="closeFieldSlipModal()" class="w3-button w3-display-topright" aria-label="{% trans 'Close modal' %}">&times;</button>
          <h2 id="fieldSlipModalTitle">{% trans "Create and link new field slip" %}</h2>
        </header>
        <div class="w3-container">
          <iframe id="fieldSlipFrame" src="" width="100%" height="500" style="border: none;" title="{% trans 'Field slip form' %}"></iframe>
        </div>
        <footer class="w3-container w3-padding w3-light-grey">
          <button type="button" onclick="closeFieldSlipModal()" class="w3-button w3-red">{% trans "Cancel" %}</button>
        </footer>
      </div>
    </div>
  {% endif %}

  <div id="media-hover-preview" class="w3-card w3-round-large w3-white w3-padding" style="display: none; position: fixed; z-index: 10; max-width: 360px;" aria-hidden="true">
    <img id="media-hover-preview-img" src="" alt="" class="w3-image" />
  </div>
</main>
{% endblock %}

{% block extra_scripts %}
<script>
  function openFieldSlipModal() {
    const url = "{% url 'accession_create_fieldslip' accession.pk %}";
    document.getElementById("fieldSlipFrame").src = url;
    document.getElementById("fieldSlipModal").style.display = "block";
  }

  function closeFieldSlipModal() {
    document.getElementById("fieldSlipModal").style.display = "none";
    document.getElementById("fieldSlipFrame").src = "";
  }

  function closeModalAndRefresh() {
    closeFieldSlipModal();
    location.reload();
  }

  document.addEventListener("DOMContentLoaded", function () {
    const previewContainer = document.getElementById("media-hover-preview");
    const previewImage = document.getElementById("media-hover-preview-img");
    const triggers = document.querySelectorAll(".media-preview-trigger");
    const offset = 16;

    function positionPreview(trigger, event) {
      let x;
      let y;

      if (event.type === "mousemove" || event.type === "mouseenter") {
        x = event.clientX + offset;
        y = event.clientY + offset;
      } else {
        const rect = trigger.getBoundingClientRect();
        x = rect.right + offset;
        y = rect.top;
      }

      const containerRect = previewContainer.getBoundingClientRect();
      const maxX = window.innerWidth - containerRect.width - offset;
      const maxY = window.innerHeight - containerRect.height - offset;

      const clampedX = Math.max(offset, Math.min(x, maxX));
      const clampedY = Math.max(offset, Math.min(y, maxY));

      previewContainer.style.left = `${clampedX}px`;
      previewContainer.style.top = `${clampedY}px`;
    }

    function hidePreview() {
      previewContainer.style.display = "none";
      previewContainer.setAttribute("aria-hidden", "true");
      previewImage.removeAttribute("src");
      previewImage.setAttribute("alt", "");
    }

    function showPreview(event) {
      const trigger = event.currentTarget;
      const previewUrl = trigger.getAttribute("data-media-preview");

      if (!previewUrl) {
        return;
      }

      previewImage.setAttribute("src", previewUrl);
      previewImage.setAttribute("alt", trigger.getAttribute("data-media-alt") || "");
      previewContainer.style.display = "block";
      previewContainer.setAttribute("aria-hidden", "false");
      positionPreview(trigger, event);
    }

    triggers.forEach(function (trigger) {
      trigger.addEventListener("mouseenter", showPreview);
      trigger.addEventListener("mousemove", function (event) {
        if (previewContainer.style.display === "block") {
          positionPreview(trigger, event);
        }
      });
      trigger.addEventListener("mouseleave", hidePreview);
      trigger.addEventListener("focus", function (event) {
        showPreview(event);
        positionPreview(trigger, event);
      });
      trigger.addEventListener("blur", hidePreview);
    });

    window.addEventListener("scroll", hidePreview, true);
  });
</script>
{% endblock %}
