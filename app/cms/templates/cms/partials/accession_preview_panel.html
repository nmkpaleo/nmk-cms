{% load custom_filters user_tags %}
<div class="grid-containerr">
  <div class="cards">
    <table>
      <caption><b><u>Accession</u></b></caption>
      <tbody>
        <tr>
          <th>ACC No.:</th>
          <td>{{ accession }}</td>
        </tr>
        <tr>
          <th>Locality:</th>
          <td>{{ accession.specimen_prefix }}</td>
        </tr>
        <tr>
          <th>Type specimen:</th>
          <td>{{ accession.type_status }}</td>
        </tr>
        {% if not preview_mode %}
          {% if user.is_superuser or user|has_group:"Collection Managers" %}
        <tr>
          <th>Accessioned by:</th>
          <td>{{ accession.accessioned_by }}</td>
        </tr>
          {% endif %}
        {% endif %}
        <tr>
          <th>General comment:</th>
          <td>{{ accession.comment }}</td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="cards">
    {% if not preview_mode and user.is_authenticated and user|has_group:"Collection Managers" %}
      <a href="{% url 'accession_add_geology' accession.id %}">➕ Add Horizon</a>
    {% endif %}
    <table>
      <caption><b><u>Horizon</u></b></caption>
      <thead>
        <tr>
          <th>Upper</th>
          <th>Lower</th>
        </tr>
      </thead>
      <tbody>
        {% for geology in geologies %}
          <tr>
            <td>{{ geology.earliest_geological_context }}</td>
            <td>{{ geology.latest_geological_context }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="2">No horizon data recorded.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <hr class="accession_hr">

    {% if not preview_mode and user.is_authenticated and user|has_group:"Collection Managers" %}
      <a href="{% url 'accession_add_row' accession.id %}">➕ Add Specimen</a>
    {% endif %}
    <table>
      <caption><em>Specimen details</em></caption>
      <thead>
        <tr>
          <th>Specimen</th>
          <th>Storage</th>
          <th>Element</th>
          <th>Side</th>
          <th>Description</th>
          <th>Taxon</th>
          <th>Family</th>
          <th>Subfamily</th>
          <th>Tribe</th>
          <th>Genus</th>
          <th>Species</th>
        </tr>
      </thead>
      <tbody>
        {% for accessionrow in accession_rows %}
          {% with specimens=accessionrow.natureofspecimen_set.all %}
          <tr>
            <td>
              {% if preview_mode %}
                {{ accessionrow.specimen_suffix }}
              {% else %}
                <a href="{% url 'accessionrow_detail' accessionrow.pk %}">{{ accessionrow.specimen_suffix }}</a>
              {% endif %}
            </td>
            <td>{{ accessionrow.storage }}</td>
            <td>
              {% if specimens %}
                {% for specimen in specimens %}
                  {{ specimen.element|default:"—" }}{% if not forloop.last %}<br>{% endif %}
                {% endfor %}
              {% else %}
                &mdash;
              {% endif %}
            </td>
            <td>
              {% if specimens %}
                {% for specimen in specimens %}
                  {{ specimen.side|default:"—" }}{% if not forloop.last %}<br>{% endif %}
                {% endfor %}
              {% else %}
                &mdash;
              {% endif %}
            </td>
            <td>
              {% if specimens %}
                {% for specimen in specimens %}
                  {{ specimen.verbatim_element|default:"—" }}{% if not forloop.last %}<br>{% endif %}
                {% endfor %}
              {% else %}
                &mdash;
              {% endif %}
            </td>
            {% with first_identifications|get_item:accessionrow.id as first_identification %}
              {% if first_identification %}
                {% with taxonomy|get_item:first_identification.id as matched_taxon %}
                  <td>
                    {{ first_identification.taxon }}
                    {% if identification_counts|get_item:accessionrow.id > 1 %}
                      <span title="This specimen has previous identifications">(*)</span>
                    {% endif %}
                  </td>
                  <td>{{ matched_taxon.family|default:"-" }}</td>
                  <td>{{ matched_taxon.subfamily|default:"-" }}</td>
                  <td>{{ matched_taxon.tribe|default:"-" }}</td>
                  <td>{{ matched_taxon.genus|default:"-" }}</td>
                  <td>{{ matched_taxon.species|default:"-" }}</td>
                {% endwith %}
              {% else %}
                <td>No Taxon identified</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
              {% endif %}
            {% endwith %}
          </tr>
          {% endwith %}
        {% empty %}
          <tr>
            <td colspan="11">No specimen rows recorded.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <hr class="accession_hr">

    {% if not preview_mode and user.is_authenticated and user|has_group:"Collection Managers" %}
      <a href="{% url 'accession_add_reference' accession.id %}">➕ Add Reference</a>
    {% endif %}
    {% if references %}
      <table>
        <caption>References</caption>
        <thead>
          <tr>
            <th>Year</th>
            <th>First author</th>
            <th>Title</th>
            <th>Page(s)</th>
          </tr>
        </thead>
        <tbody>
          {% for ref in references %}
            <tr>
              <td>{{ ref.reference.year }}</td>
              <td>{{ ref.reference.first_author }}</td>
              <td>{{ ref.reference.title }}</td>
              <td>{{ ref.page }}</td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3">{{ references|length }} References</td>
          </tr>
        </tfoot>
      </table>
    {% else %}
      <p>No References found for this accession.</p>
    {% endif %}

    <hr class="accession_hr">

    {% if preview_mode %}
      <style>
        .fieldslip-meta-grid {
          display: grid;
          gap: 0.25rem 0.5rem;
          grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }
        .fieldslip-meta-grid strong {
          font-weight: 600;
        }
      </style>
      <table>
        <caption><b><u>Field Slips</u></b></caption>
        <thead>
          <tr>
            <th>Field Number</th>
            <th>Verbatim Locality</th>
            <th>Verbatim Taxon</th>
            <th>Verbatim Element</th>
          </tr>
        </thead>
        <tbody>
          {% if fieldslips %}
            {% for slip in fieldslips %}
              <tr>
                <td>{{ slip.field_number|default:"—" }}</td>
                <td>{{ slip.verbatim_locality|default:"—" }}</td>
                <td>{{ slip.verbatim_taxon|default:"—" }}</td>
                <td>{{ slip.verbatim_element|default:"—" }}</td>
              </tr>
              {% if slip.horizon_formation or slip.horizon_member or slip.horizon_bed or slip.horizon_chronostratigraphy or slip.verbatim_latitude or slip.verbatim_longitude or slip.verbatim_elevation or slip.aerial_photo %}
                <tr>
                  <td colspan="4">
                    <small class="fieldslip-meta-grid">
                      {% if slip.horizon_formation or slip.horizon_member or slip.horizon_bed or slip.horizon_chronostratigraphy %}
                        <div>
                          <strong>Verbatim horizon:</strong>
                          <span>
                            {% if slip.horizon_formation %}{{ slip.horizon_formation }}{% endif %}
                            {% if slip.horizon_member %}{% if slip.horizon_formation %}, {% endif %}{{ slip.horizon_member }}{% endif %}
                            {% if slip.horizon_bed %}{% if slip.horizon_formation or slip.horizon_member %}, {% endif %}{{ slip.horizon_bed }}{% endif %}
                            {% if slip.horizon_chronostratigraphy %}{% if slip.horizon_formation or slip.horizon_member or slip.horizon_bed %}, {% endif %}{{ slip.horizon_chronostratigraphy }}{% endif %}
                          </span>
                        </div>
                      {% endif %}
                      {% if slip.verbatim_latitude or slip.verbatim_longitude or slip.verbatim_elevation %}
                        <div>
                          <strong>Coordinates:</strong>
                          <span>
                            {% if slip.verbatim_latitude %}Lat {{ slip.verbatim_latitude }}{% endif %}
                            {% if slip.verbatim_longitude %}{% if slip.verbatim_latitude %}, {% endif %}Lon {{ slip.verbatim_longitude }}{% endif %}
                            {% if slip.verbatim_elevation %}{% if slip.verbatim_latitude or slip.verbatim_longitude %}, {% endif %}Elev {{ slip.verbatim_elevation }}{% endif %}
                          </span>
                        </div>
                      {% endif %}
                      {% if slip.aerial_photo %}
                        <div>
                          <strong>Aerial photo:</strong> {{ slip.aerial_photo }}
                        </div>
                      {% endif %}
                    </small>
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4">No Field Slips linked to this accession.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>

      <hr class="accession_hr">
    {% endif %}

    {% if not preview_mode and user.is_authenticated and user|has_group:"Collection Managers" %}
      <a href="{% url 'accession_upload_media' accession.id %}">➕ Upload Media</a>
    {% endif %}
    <table>
      <caption><em>Media</em></caption>
      <thead>
        <tr>
          <th>File Name</th>
          <th>Type</th>
          <th>License</th>
          <th>Media</th>
        </tr>
      </thead>
      <tbody>
        {% if accession.media.all %}
          {% for media in accession.media.all %}
            <tr>
              <td>{{ media.file_name }}</td>
              <td>{{ media.type }}</td>
              <td>{{ media.get_license_display }}</td>
              <td>
                {% if media.media_location %}
                  <a href="{{ media.media_location.url }}" target="_blank">
                    {% if media.type == "photo" %}
                      <img src="{{ media.media_location.url }}" alt="{{ media.file_name }}" height="100">
                    {% else %}
                      View File
                    {% endif %}
                  </a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4">There are no media files available for this accession.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
