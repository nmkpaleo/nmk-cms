{% extends "base_generic.html" %}

{% block title %}Drawers{% endblock %}

{% block content %}
<div class="w3-container w3-margin-top">
  <div class="w3-row w3-margin-bottom w3-padding-16 w3-border-bottom">
    <div class="w3-col s12 m6 l6">
      <h2 class="w3-margin-0">Drawers</h2>
    </div>
    <div class="w3-col s12 m6 l6 w3-right-align w3-margin-top">
      {% if can_edit %}
        <a href="{% url 'drawerregister_create' %}" class="w3-button w3-green w3-round">
          <i class="fa-solid fa-plus-circle"></i>
          New Drawer
        </a>
      {% endif %}
    </div>
  </div>
  <button type="button" onclick="toggleAccordion('drawerFilterPanel')" class="w3-button w3-light-grey w3-round-large">
    <i class="fa-solid fa-filter"></i>
    <span class="w3-margin-left">Show/Hide Filters</span>
  </button>

  <div id="drawerFilterPanel" class="w3-hide w3-animate-opacity w3-padding w3-light-grey w3-round-large w3-margin-top w3-card">
    <form method="get">
      <div class="w3-row-padding">
        <div class="w3-col s12 m6 l4 w3-margin-bottom">
          <label class="w3-text-grey">Code</label>
          {{ filter.form.code }}
        </div>
        <div class="w3-col s12 m6 l4 w3-margin-bottom">
          <label class="w3-text-grey">Status</label>
          {{ filter.form.scanning_status }}
        </div>
        <div class="w3-col s12 m6 l4 w3-margin-bottom">
          <label class="w3-text-grey">Locality</label>
          {{ filter.form.localities }}
        </div>
      </div>
      <div class="w3-row-padding">
        <div class="w3-col s12 m6 l4 w3-margin-bottom">
          <label class="w3-text-grey">Taxon</label>
          {{ filter.form.taxa }}
        </div>
      </div>
      <div class="w3-margin-top">
        <button type="submit" class="w3-button w3-blue w3-round w3-margin-right">
          <i class="fa-solid fa-check"></i>
          Apply Filters
        </button>
        <a href="{% url 'drawerregister_list' %}" class="w3-button w3-gray w3-round">
          <i class="fa-solid fa-rotate-left"></i>
          Clear
        </a>
      </div>
    </form>
  </div>

  <div class="w3-responsive w3-margin-top">
    <table id="drawerTable" class="w3-table-all w3-hoverable">
      <thead>
        <tr>
          {% if can_edit %}<th class="w3-center" aria-label="Reorder"></th>{% endif %}
          <th>Code</th>
          <th>Description</th>
          <th>Taxa</th>
          <th>Localities</th>
          <th>Estimated Documents</th>
          <th>Status</th>
          <th>Scanning Users</th>
        </tr>
      </thead>
      <tbody id="drawerTableBody">
      {% for drawer in drawers %}
      <tr data-id="{{ drawer.pk }}">
        {% if can_edit %}
          <td class="drag-handle w3-center" style="cursor: move;">
            <i class="fa-solid fa-grip-lines"></i>
          </td>
        {% endif %}
        <td><a href="{% url 'drawerregister_detail' drawer.pk %}">{{ drawer.code }}</a></td>
        <td>{{ drawer.description }}</td>
        <td>{{ drawer.taxa.all|join:", " }}</td>
        <td>{{ drawer.localities.all|join:", " }}</td>
        <td>{{ drawer.estimated_documents }}</td>
        <td>{{ drawer.get_scanning_status_display }}</td>
        <td>{{ drawer.scanning_users.all|join:", " }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="{% if can_edit %}8{% else %}7{% endif %}" class="w3-center">No drawers found.</td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
function toggleAccordion(id) {
    var panel = document.getElementById(id);
    if (panel.classList.contains("w3-show")) {
        panel.classList.remove("w3-show");
        panel.classList.add("w3-hide");
    } else {
        panel.classList.remove("w3-hide");
        panel.classList.add("w3-show");
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    var canEdit = {{ can_edit|yesno:'true,false' }};
    if (canEdit) {
        const tbody = document.getElementById('drawerTableBody');
        tbody.querySelectorAll('tr').forEach(function(row) {
            const handle = row.querySelector('.drag-handle');
            if (handle) {
                handle.draggable = true;
            }
        });

        let draggingRow = null;

        tbody.addEventListener('dragstart', function(e) {
            const handle = e.target.closest('.drag-handle');
            if (!handle) {
                return;
            }
            draggingRow = handle.closest('tr');
            e.dataTransfer.setData('text/plain', '');
            e.dataTransfer.effectAllowed = 'move';
        });

        tbody.addEventListener('dragend', function() {
            draggingRow = null;
        });

        tbody.addEventListener('dragover', function(e) {
            e.preventDefault();
            const target = e.target.closest('tr');
            if (draggingRow && target && target !== draggingRow) {
                const rect = target.getBoundingClientRect();
                const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
                target.parentNode.insertBefore(draggingRow, next ? target.nextSibling : target);
            }
        });

        tbody.addEventListener('drop', function(e) {
            e.preventDefault();
            const order = Array.from(tbody.querySelectorAll('tr')).map(function(tr) {
                return tr.dataset.id;
            });
            fetch('{% url "drawerregister_reorder" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({order: order})
            });
        });
    }
});
</script>
{% endblock %}
