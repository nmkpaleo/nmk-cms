{% extends "base_generic.html" %}
{% load i18n %}

{% block title %}{% translate "Taxonomy Sync Result" %}{% endblock %}

{% block content %}
<header class="w3-container w3-padding-16 w3-border-bottom">
  <h1 class="w3-xxlarge w3-margin-bottom">
    {% if success %}
    <i class="fa-solid fa-circle-check w3-text-green" aria-hidden="true"></i>
    {% else %}
    <i class="fa-solid fa-triangle-exclamation w3-text-red" aria-hidden="true"></i>
    {% endif %}
    {% translate "Taxonomy Sync Result" %}
  </h1>
  <p class="w3-text-gray">
    {% translate "The NOW dataset sync has completed. Review the applied changes below." %}
  </p>
  {% if source_version %}
  <p class="w3-small w3-text-gray">
    <i class="fa-solid fa-code-branch" aria-hidden="true"></i>
    {% blocktranslate %}Source version: {{ source_version }}{% endblocktranslate %}
  </p>
  {% endif %}
</header>

<main class="w3-container" role="main">
  <section class="w3-section">
    {% if success %}
    <div class="w3-panel w3-pale-green w3-border w3-border-green" role="status">
      <p class="w3-large">
        {% translate "NOW taxonomy sync completed successfully." %}
      </p>
      <p class="w3-small">
        {% translate "All changes were applied in a single transaction." %}
      </p>
    </div>
    {% else %}
    <div class="w3-panel w3-pale-red w3-border w3-border-red" role="alert">
      <p class="w3-large">
        {% translate "The sync completed with issues. Review the details below." %}
      </p>
    </div>
    {% endif %}
    <div class="w3-row-padding">
      <article class="w3-col l2 m4 s12 w3-margin-bottom">
        <div class="w3-card w3-white w3-padding w3-center">
          <i class="fa-solid fa-plus-circle w3-xxlarge w3-text-green" aria-hidden="true"></i>
          <p class="w3-xlarge w3-margin-top">{{ counts.created }}</p>
          <p class="w3-small">{% translate "Records created" %}</p>
        </div>
      </article>
      <article class="w3-col l2 m4 s12 w3-margin-bottom">
        <div class="w3-card w3-white w3-padding w3-center">
          <i class="fa-solid fa-pen w3-xxlarge w3-text-indigo" aria-hidden="true"></i>
          <p class="w3-xlarge w3-margin-top">{{ counts.updated }}</p>
          <p class="w3-small">{% translate "Records updated" %}</p>
        </div>
      </article>
      <article class="w3-col l2 m4 s12 w3-margin-bottom">
        <div class="w3-card w3-white w3-padding w3-center">
          <i class="fa-solid fa-link w3-xxlarge w3-text-teal" aria-hidden="true"></i>
          <p class="w3-xlarge w3-margin-top">{{ counts.synonym_links }}</p>
          <p class="w3-small">{% translate "Synonym links" %}</p>
        </div>
      </article>
      <article class="w3-col l2 m4 s12 w3-margin-bottom">
        <div class="w3-card w3-white w3-padding w3-center">
          <i class="fa-solid fa-eye-slash w3-xxlarge w3-text-orange" aria-hidden="true"></i>
          <p class="w3-xlarge w3-margin-top">{{ counts.deactivated }}</p>
          <p class="w3-small">{% translate "Records deactivated" %}</p>
        </div>
      </article>
      <article class="w3-col l2 m4 s12 w3-margin-bottom">
        <div class="w3-card w3-white w3-padding w3-center">
          <i class="fa-solid fa-triangle-exclamation w3-xxlarge w3-text-red" aria-hidden="true"></i>
          <p class="w3-xlarge w3-margin-top">{{ counts.issues }}</p>
          <p class="w3-small">{% translate "Issues detected" %}</p>
        </div>
      </article>
    </div>
    {% if log_url %}
    <p class="w3-small">
      <a href="{{ log_url }}" class="w3-button w3-white w3-border">
        <i class="fa-solid fa-file-alt" aria-hidden="true"></i>
        {% translate "View import log" %}
      </a>
    </p>
    {% endif %}
  </section>

  <section class="w3-section">
    <header class="w3-margin-bottom">
      <h2 class="w3-xlarge">
        <i class="fa-solid fa-plus-circle" aria-hidden="true"></i>
        {% translate "Accepted taxa created" %}
      </h2>
    </header>
    {% if preview_data.accepted_creates %}
    <div class="w3-responsive">
      <table class="w3-table-all w3-small">
        <thead>
          <tr>
            <th scope="col">{% translate "Name" %}</th>
            <th scope="col">{% translate "Rank" %}</th>
            <th scope="col">{% translate "Author" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for record in preview_data.accepted_creates %}
          <tr>
            <td>{{ record.name }}</td>
            <td>
              {% if record.rank %}
                {{ record.rank }}
              {% else %}
                {% translate "Unknown" %}
              {% endif %}
            </td>
            <td>{{ record.author_year|default:"â€”" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="w3-text-gray">{% translate "No accepted taxa were created." %}</p>
    {% endif %}
  </section>

  <section class="w3-section">
    <header class="w3-margin-bottom">
      <h2 class="w3-xlarge">
        <i class="fa-solid fa-pen" aria-hidden="true"></i>
        {% translate "Accepted taxa updated" %}
      </h2>
    </header>
    {% if preview_data.accepted_updates %}
    <div class="w3-responsive">
      <table class="w3-table-all w3-small">
        <thead>
          <tr>
            <th scope="col">{% translate "Name" %}</th>
            <th scope="col">{% translate "Changes" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for update in preview_data.accepted_updates %}
          <tr>
            <td>{{ update.name }}</td>
            <td>
              <ul class="w3-ul w3-small">
                {% for change in update.changes %}
                <li>
                  <strong>{{ change.label }}:</strong>
                  <span class="w3-text-gray">{% translate "Previous" %}:</span> {{ change.old }}
                  <span class="w3-text-gray">{% translate "New" %}:</span> {{ change.new }}
                </li>
                {% endfor %}
              </ul>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="w3-text-gray">{% translate "No accepted taxa required updates." %}</p>
    {% endif %}
  </section>

  <section class="w3-section">
    <header class="w3-margin-bottom">
      <h2 class="w3-xlarge">
        <i class="fa-solid fa-link" aria-hidden="true"></i>
        {% translate "Synonym changes" %}
      </h2>
    </header>
    {% if preview_data.synonym_creates or preview_data.synonym_updates %}
    <div class="w3-responsive">
      <table class="w3-table-all w3-small">
        <thead>
          <tr>
            <th scope="col">{% translate "Synonym" %}</th>
            <th scope="col">{% translate "Accepted taxon" %}</th>
            <th scope="col">{% translate "Changes" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for record in preview_data.synonym_creates %}
          <tr>
            <td>{{ record.name }}</td>
            <td>{{ record.accepted_name }}</td>
            <td>{% translate "Created" %}</td>
          </tr>
          {% endfor %}
          {% for update in preview_data.synonym_updates %}
          <tr>
            <td>{{ update.name }}</td>
            <td>{{ update.accepted_name }}</td>
            <td>
              <ul class="w3-ul w3-small">
                {% for change in update.changes %}
                <li>
                  <strong>{{ change.label }}:</strong>
                  <span class="w3-text-gray">{% translate "Previous" %}:</span> {{ change.old }}
                  <span class="w3-text-gray">{% translate "New" %}:</span> {{ change.new }}
                </li>
                {% endfor %}
              </ul>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="w3-text-gray">{% translate "No synonym changes were necessary." %}</p>
    {% endif %}
  </section>

  <section class="w3-section">
    <header class="w3-margin-bottom">
      <h2 class="w3-xlarge">
        <i class="fa-solid fa-eye-slash" aria-hidden="true"></i>
        {% translate "Records deactivated" %}
      </h2>
    </header>
    {% if preview_data.deactivations %}
    <div class="w3-responsive">
      <table class="w3-table-all w3-small">
        <thead>
          <tr>
            <th scope="col">{% translate "Name" %}</th>
            <th scope="col">{% translate "External ID" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for taxon in preview_data.deactivations %}
          <tr>
            <td>{{ taxon.taxon_name }}</td>
            <td>{{ taxon.external_id }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="w3-text-gray">{% translate "No records were deactivated." %}</p>
    {% endif %}
  </section>

  <section class="w3-section">
    <header class="w3-margin-bottom">
      <h2 class="w3-xlarge">
        <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i>
        {% translate "Issues" %}
      </h2>
    </header>
    {% if preview_data.issues %}
    <div class="w3-panel w3-pale-red w3-border w3-border-red" role="alert">
      <ul class="w3-ul w3-small">
        {% for issue in preview_data.issues %}
        <li>
          <strong>{{ issue.code }}</strong>: {{ issue.message }}
          {% if issue.context %}
          <code class="w3-small">{{ issue.context }}</code>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    </div>
    {% else %}
    <p class="w3-text-gray">{% translate "No issues were reported." %}</p>
    {% endif %}
  </section>

  <section class="w3-section w3-padding-16">
    <div class="w3-bar">
      <a href="{{ back_url }}" class="w3-button w3-teal w3-margin-right">
        <i class="fa-solid fa-table-list" aria-hidden="true"></i>
        {% translate "Back to taxonomy" %}
      </a>
      <a href="{{ preview_url }}" class="w3-button w3-white w3-border">
        <i class="fa-solid fa-rotate" aria-hidden="true"></i>
        {% translate "Run preview again" %}
      </a>
    </div>
  </section>
</main>
{% endblock %}
