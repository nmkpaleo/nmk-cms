{% extends "base_generic.html" %}
{% load i18n %}

{% block title %}{% translate "Sync Taxa Now" %}{% endblock %}

{% block content %}
<header class="w3-container w3-padding-16 w3-border-bottom">
  <h1 class="w3-xxlarge w3-margin-bottom">
    <i class="fa-solid fa-rotate" aria-hidden="true"></i>
    {% translate "Sync Taxa Now" %}
  </h1>
  <p class="w3-text-gray">
    {% translate "Review the proposed NOW taxonomy changes before applying them." %}
  </p>
  {% if source_version %}
  <p class="w3-small w3-text-gray">
    <i class="fa-solid fa-code-branch" aria-hidden="true"></i>
    {% blocktranslate %}Source version: {{ source_version }}{% endblocktranslate %}
  </p>
  {% endif %}
</header>

<main class="w3-container" role="main">
  <section class="w3-section">
    <div class="w3-panel w3-pale-blue w3-leftbar w3-border-blue" aria-live="polite">
      <p class="w3-large w3-margin-bottom">
        {% translate "Summary" %}
      </p>
      <div class="w3-row-padding">
        <article class="w3-col l2 m4 s12 w3-margin-bottom">
          <div class="w3-card w3-white w3-padding w3-center">
            <i class="fa-solid fa-plus-circle w3-xxlarge w3-text-green" aria-hidden="true"></i>
            <p class="w3-xlarge w3-margin-top">{{ counts.created }}</p>
            <p class="w3-small">{% translate "Records to create" %}</p>
          </div>
        </article>
        <article class="w3-col l2 m4 s12 w3-margin-bottom">
          <div class="w3-card w3-white w3-padding w3-center">
            <i class="fa-solid fa-pen w3-xxlarge w3-text-indigo" aria-hidden="true"></i>
            <p class="w3-xlarge w3-margin-top">{{ counts.updated }}</p>
            <p class="w3-small">{% translate "Records to update" %}</p>
          </div>
        </article>
        <article class="w3-col l2 m4 s12 w3-margin-bottom">
          <div class="w3-card w3-white w3-padding w3-center">
            <i class="fa-solid fa-link w3-xxlarge w3-text-teal" aria-hidden="true"></i>
            <p class="w3-xlarge w3-margin-top">{{ counts.synonym_links }}</p>
            <p class="w3-small">{% translate "Synonym links" %}</p>
          </div>
        </article>
        <article class="w3-col l2 m4 s12 w3-margin-bottom">
          <div class="w3-card w3-white w3-padding w3-center">
            <i class="fa-solid fa-eye-slash w3-xxlarge w3-text-orange" aria-hidden="true"></i>
            <p class="w3-xlarge w3-margin-top">{{ counts.deactivated }}</p>
            <p class="w3-small">{% translate "Records to deactivate" %}</p>
          </div>
        </article>
        <article class="w3-col l2 m4 s12 w3-margin-bottom">
          <div class="w3-card w3-white w3-padding w3-center">
            <i class="fa-solid fa-triangle-exclamation w3-xxlarge w3-text-red" aria-hidden="true"></i>
            <p class="w3-xlarge w3-margin-top">{{ counts.issues }}</p>
            <p class="w3-small">{% translate "Issues detected" %}</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <section class="w3-section">
    <header class="w3-margin-bottom">
      <h2 class="w3-xlarge">
        <i class="fa-solid fa-plus-circle" aria-hidden="true"></i>
        {% translate "Accepted taxa to create" %}
      </h2>
    </header>
    {% if preview_data.accepted_creates %}
    <div class="w3-responsive">
      <table class="w3-table-all w3-small">
        <thead>
          <tr>
            <th scope="col">{% translate "Name" %}</th>
            <th scope="col">{% translate "Rank" %}</th>
            <th scope="col">{% translate "Author" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for record in preview_data.accepted_creates %}
          <tr>
            <td>{{ record.name }}</td>
            <td>
              {% if record.rank %}
                {{ record.rank }}
              {% else %}
                {% translate "Unknown" %}
              {% endif %}
            </td>
            <td>{{ record.author_year|default:"â€”" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="w3-text-gray">{% translate "No new accepted taxa will be created." %}</p>
    {% endif %}
  </section>

  <section class="w3-section">
    <header class="w3-margin-bottom">
      <h2 class="w3-xlarge">
        <i class="fa-solid fa-pen" aria-hidden="true"></i>
        {% translate "Accepted taxa to update" %}
      </h2>
    </header>
    {% if preview_data.accepted_updates %}
    <div class="w3-responsive">
      <table class="w3-table-all w3-small">
        <thead>
          <tr>
            <th scope="col">{% translate "Name" %}</th>
            <th scope="col">{% translate "Changes" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for update in preview_data.accepted_updates %}
          <tr>
            <td>{{ update.name }}</td>
            <td>
              <ul class="w3-ul w3-small">
                {% for change in update.changes %}
                <li>
                  <strong>{{ change.label }}:</strong>
                  <span class="w3-text-gray">{% translate "Current" %}:</span> {{ change.old }}
                  <span class="w3-text-gray">{% translate "New" %}:</span> {{ change.new }}
                </li>
                {% endfor %}
              </ul>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="w3-text-gray">{% translate "No accepted taxa will be updated." %}</p>
    {% endif %}
  </section>

  <section class="w3-section">
    <header class="w3-margin-bottom">
      <h2 class="w3-xlarge">
        <i class="fa-solid fa-link" aria-hidden="true"></i>
        {% translate "Synonyms" %}
      </h2>
    </header>
    {% if preview_data.synonym_creates or preview_data.synonym_updates %}
    <div class="w3-responsive">
      <table class="w3-table-all w3-small">
        <thead>
          <tr>
            <th scope="col">{% translate "Synonym" %}</th>
            <th scope="col">{% translate "Accepted taxon" %}</th>
            <th scope="col">{% translate "Changes" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for record in preview_data.synonym_creates %}
          <tr>
            <td>{{ record.name }}</td>
            <td>{{ record.accepted_name }}</td>
            <td>{% translate "Create link" %}</td>
          </tr>
          {% endfor %}
          {% for update in preview_data.synonym_updates %}
          <tr>
            <td>{{ update.name }}</td>
            <td>{{ update.accepted_name }}</td>
            <td>
              <ul class="w3-ul w3-small">
                {% for change in update.changes %}
                <li>
                  <strong>{{ change.label }}:</strong>
                  <span class="w3-text-gray">{% translate "Current" %}:</span> {{ change.old }}
                  <span class="w3-text-gray">{% translate "New" %}:</span> {{ change.new }}
                </li>
                {% endfor %}
              </ul>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="w3-text-gray">{% translate "No synonym changes detected." %}</p>
    {% endif %}
  </section>

  <section class="w3-section">
    <header class="w3-margin-bottom">
      <h2 class="w3-xlarge">
        <i class="fa-solid fa-eye-slash" aria-hidden="true"></i>
        {% translate "Records to deactivate" %}
      </h2>
    </header>
    {% if preview_data.deactivations %}
    <div class="w3-responsive">
      <table class="w3-table-all w3-small">
        <thead>
          <tr>
            <th scope="col">{% translate "Name" %}</th>
            <th scope="col">{% translate "External ID" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for taxon in preview_data.deactivations %}
          <tr>
            <td>{{ taxon.taxon_name }}</td>
            <td>{{ taxon.external_id }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="w3-text-gray">{% translate "No active records will be deactivated." %}</p>
    {% endif %}
  </section>

  <section class="w3-section">
    <header class="w3-margin-bottom">
      <h2 class="w3-xlarge">
        <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i>
        {% translate "Issues" %}
      </h2>
    </header>
    {% if preview_data.issues %}
    <div class="w3-panel w3-pale-red w3-border w3-border-red" role="alert">
      <ul class="w3-ul w3-small">
        {% for issue in preview_data.issues %}
        <li>
          <strong>{{ issue.code }}</strong>: {{ issue.message }}
          {% if issue.context %}
          <code class="w3-small">{{ issue.context }}</code>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    </div>
    {% else %}
    <p class="w3-text-gray">{% translate "No issues detected." %}</p>
    {% endif %}
  </section>

  <section class="w3-section w3-padding-16">
    <form method="post" action="{{ apply_url }}" class="w3-bar w3-margin-bottom">
      {% csrf_token %}
      <button type="submit" class="w3-button w3-teal w3-margin-right">
        <i class="fa-solid fa-rotate" aria-hidden="true"></i>
        {% translate "Apply sync" %}
      </button>
      <a href="{{ back_url }}" class="w3-button w3-white w3-border">
        {% translate "Cancel" %}
      </a>
    </form>
  </section>
</main>
{% endblock %}
