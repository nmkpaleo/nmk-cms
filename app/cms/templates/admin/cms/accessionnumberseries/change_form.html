{% extends "admin/change_form.html" %}
{% load i18n %}

{% block form_top %}
  <section
    class="w3-panel w3-pale-blue w3-leftbar w3-border-blue w3-round-large"
    aria-label="{% trans "Organisation context" %}"
  >
    <header class="w3-margin-bottom">
      <h2 class="w3-large">
        <i class="fa-solid fa-building-columns" aria-hidden="true"></i>
        <span class="w3-margin-left">{% trans "Organisation context" %}</span>
      </h2>
    </header>
    <p class="w3-text-black">
      {% if original and original.organisation %}
        {% blocktrans with org=original.organisation.name %}This accession number series belongs to {{ org }}.{% endblocktrans %}
      {% elif adminform.form.initial.organisation %}
        {% blocktrans with org=adminform.form.initial.organisation %}New series will be created for {{ org }}.{% endblocktrans %}
      {% elif request.user.organisation_membership.organisation %}
        {% blocktrans with org=request.user.organisation_membership.organisation %}You are creating a series for your organisation: {{ org }}.{% endblocktrans %}
      {% else %}
        {% trans "No organisation is associated with your account. Please assign one before creating a series." %}
      {% endif %}
    </p>
  </section>
{% endblock %}

{% block submit_buttons_bottom %}
  {% if original %}
    <div class="submit-row">
      <a class="button" href="{% url 'admin:cms_accessionnumberseries_changelist' %}">
        Back to Accession Number Series List
      </a>
    </div>
  {% else %}
    {{ block.super }}
  {% endif %}
{% endblock %}

  {% block extrahead %}
    {{ block.super }}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const organisationField = document.getElementById('id_organisation');
        const userField = document.getElementById('id_user');

        if (!organisationField || !userField) {
          return;
        }

        const allOptions = Array.from(userField.options).map(function (option) {
          return option.cloneNode(true);
        });

        const placeholder =
          allOptions.find(function (option) {
            return option.value === '';
          }) || new Option('---------', '');

        function filterUsers() {
          const selectedOrg = organisationField.value;

          userField.innerHTML = '';
          userField.appendChild(placeholder.cloneNode(true));

          if (!selectedOrg) {
            return;
          }

          allOptions.forEach(function (option) {
            const orgId = option.dataset ? option.dataset.organisation : null;

            if (orgId && String(orgId) === String(selectedOrg)) {
              userField.appendChild(option.cloneNode(true));
            }
          });

          userField.selectedIndex = 0;
        }

        filterUsers();

        organisationField.addEventListener('change', filterUsers);

        if (window.django && window.django.jQuery) {
          const $ = window.django.jQuery;
          $(organisationField).on('select2:select select2:clear', filterUsers);
        }
      });
    </script>
  {% endblock %}
